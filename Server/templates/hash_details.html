<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hash details</title>
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='icons/site.webmanifest') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .pagination-top {
      margin-bottom: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pagination-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .pagination-controls a {
      padding: 6px 12px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .pagination-controls a:hover {
      background: #0056b3;
    }
    @media (max-width: 768px) {
      .pagination-top {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Label management styles */
    .label-badge {
      display: inline-block;
      padding: 3px 8px;
      background: #007bff;
      color: white;
      border-radius: 3px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-left: 8px;
    }
    .hash-cell {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .label-btn {
      padding: 2px 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: 8px;
    }
    .label-btn:hover {
      background: #218838;
    }
    .label-display {
      cursor: pointer;
      position: relative;
    }
    .label-display:hover::after {
      content: 'Ã—';
      margin-left: 4px;
      font-weight: bold;
    }
    .label-input-container {
      display: inline-flex;
      gap: 5px;
      margin-left: 8px;
    }
    .label-input {
      padding: 2px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 0.85rem;
      width: 120px;
    }
    .label-save {
      padding: 2px 8px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .label-cancel {
      padding: 2px 8px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8rem;
    }
  </style>
  <script>
    // Label management functions
    function showLabelInput(hash, type, button) {
      const container = document.createElement('div');
      container.className = 'label-input-container';

      // Create datalist for autocomplete
      const datalistId = 'label-options-' + Math.random().toString(36).substr(2, 9);
      const datalist = document.createElement('datalist');
      datalist.id = datalistId;

      // Get existing labels from the template
      const existingLabels = new Set();
      {% if all_labels %}
      {% for label in all_labels %}
      existingLabels.add('{{ label }}');
      {% endfor %}
      {% endif %}

      // Populate datalist
      existingLabels.forEach(label => {
        const option = document.createElement('option');
        option.value = label;
        datalist.appendChild(option);
      });

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'label-input';
      input.placeholder = 'Choose or create label';
      input.setAttribute('list', datalistId);

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'label-save';
      saveBtn.onclick = () => saveLabel(hash, type, input.value, container);

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'label-cancel';
      cancelBtn.onclick = () => container.replaceWith(button);

      container.appendChild(input);
      container.appendChild(saveBtn);
      container.appendChild(cancelBtn);

      // Append datalist to body for proper rendering
      document.body.appendChild(datalist);

      button.replaceWith(container);
      input.focus();

      // Clean up datalist when container is removed
      const observer = new MutationObserver((mutations) => {
        if (!document.body.contains(container)) {
          datalist.remove();
          observer.disconnect();
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    }

    function saveLabel(hash, type, label, container) {
      if (!label.trim()) {
        alert('Please enter a label name');
        return;
      }

      const formData = new FormData();
      formData.append('hash', hash);
      formData.append('label', label.trim());
      formData.append('hash_type', type);

      fetch('/set_label', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const badge = document.createElement('span');
          badge.className = 'label-badge label-display';
          badge.textContent = data.label;
          badge.setAttribute('data-hash', hash);
          badge.setAttribute('data-type', type);
          badge.onclick = () => deleteLabel(hash, badge);
          container.replaceWith(badge);
        } else {
          alert('Error: ' + (data.error || 'Failed to save label'));
        }
      })
      .catch(error => {
        alert('Error saving label: ' + error);
      });
    }

    function deleteLabel(hash, badge) {
      if (!confirm('Remove this label?')) {
        return;
      }

      const formData = new FormData();
      formData.append('hash', hash);

      fetch('/delete_label', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const type = badge.getAttribute('data-type');
          const button = document.createElement('button');
          button.className = 'label-btn';
          button.textContent = '+Label';
          button.onclick = () => showLabelInput(hash, type, button);
          badge.replaceWith(button);
        } else {
          alert('Error: ' + (data.error || 'Failed to delete label'));
        }
      })
      .catch(error => {
        alert('Error deleting label: ' + error);
      });
    }
  </script>
</head>
<body>
  <div class="details-container">
    <div class="details-inner">
      <div class="page-title">Hash Matches</div>

      <div class="details-grid">
        <!-- Back to search at top -->
        <div class="details-card full-width">
          <div class="pagination-top">
            <a class="back-link" href="{{ url_for('index', ip=ip_query, url=url_query, body_hash=body_hash_query, header_hash=header_hash_query, page=page) }}">&laquo; Back to search</a>
          </div>
        </div>

        <div class="details-card full-width">
          <div class="card-title">Documents with matching hash</div>
          <table>
            <thead>
              <tr>
                <th>URL</th>
                <th>Body Hash</th>
                <th>Header Hash</th>
              </tr>
            </thead>
            <tbody>
              {% for d in docs %}
              <tr>
                <td>
                  <a href="{{ url_for('details', id=d._id, ip=ip_query, url=url_query, body_hash=body_hash_query, header_hash=header_hash_query, page=page) }}">
                    {{ d.url }}
                  </a>
                </td>
                <td>
                  {% if d.get('hash') and d.hash.get('body_sha256') %}
                    <div class="hash-cell">
                      {% if d.body_label %}
                        <span class="label-badge label-display" data-hash="{{ d.hash.body_sha256 }}" data-type="body" onclick="deleteLabel('{{ d.hash.body_sha256 }}', this)">{{ d.body_label }}</span>
                      {% else %}
                        <code>{{ d.hash.body_sha256[:16] }}...</code>
                        <button class="label-btn" onclick="showLabelInput('{{ d.hash.body_sha256 }}', 'body', this)">+Label</button>
                      {% endif %}
                    </div>
                  {% else %}
                    &ndash;
                  {% endif %}
                </td>
                <td>
                  {% if d.get('hash') and d.hash.get('header_sha256') %}
                    <div class="hash-cell">
                      {% if d.header_label %}
                        <span class="label-badge label-display" data-hash="{{ d.hash.header_sha256 }}" data-type="header" onclick="deleteLabel('{{ d.hash.header_sha256 }}', this)">{{ d.header_label }}</span>
                      {% else %}
                        <code>{{ d.hash.header_sha256[:16] }}...</code>
                        <button class="label-btn" onclick="showLabelInput('{{ d.hash.header_sha256 }}', 'header', this)">+Label</button>
                      {% endif %}
                    </div>
                  {% else %}
                    &ndash;
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3">No documents found for this hash.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</body>
</html>
